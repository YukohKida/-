<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pink Noise Maker (p5.js)</title>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.4/lib/p5.min.js"></script>
  <style>
    body { margin: 0; padding: 16px; font-family: system-ui, -apple-system, sans-serif; }
    .row { margin: 10px 0; }
    label { display:inline-block; width: 140px; }
    button { padding: 10px 14px; margin-right: 8px; }
    code { background:#f3f3f3; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
<script>
let durSlider, ampSlider, fadeSlider, srSel;
let btnPreview, btnStop, btnDownload;
let statusP;

let audioCtx = null;
let currentSrc = null;
let lastBuffer = null;

function setup() {
  noCanvas();

  createElement('h2', 'ピンクノイズ生成 → WAVでダウンロード（p5.js）');

  // duration
  let row1 = createDiv().class('row');
  row1.child(createSpan('長さ（秒）: ').style('display','inline-block').style('width','140px'));
  durSlider = createSlider(2, 180, 20, 1); // 2〜180秒
  row1.child(durSlider);
  row1.child(createSpan(' ').html('&nbsp;'));
  row1.child(createSpan(() => durSlider.value() + ' s'));

  // amplitude
  let row2 = createDiv().class('row');
  row2.child(createSpan('音量（ゲイン）: ').style('display','inline-block').style('width','140px'));
  ampSlider = createSlider(0.02, 0.40, 0.12, 0.01); // 0.02〜0.40
  row2.child(ampSlider);
  row2.child(createSpan(' ').html('&nbsp;'));
  row2.child(createSpan(() => ampSlider.value().toFixed(2)));

  // fade
  let row3 = createDiv().class('row');
  row3.child(createSpan('フェード（秒）: ').style('display','inline-block').style('width','140px'));
  fadeSlider = createSlider(0.00, 0.50, 0.10, 0.01);
  row3.child(fadeSlider);
  row3.child(createSpan(' ').html('&nbsp;'));
  row3.child(createSpan(() => fadeSlider.value().toFixed(2)));

  // sample rate
  let row4 = createDiv().class('row');
  row4.child(createSpan('サンプルレート: ').style('display','inline-block').style('width','140px'));
  srSel = createSelect();
  [44100, 48000].forEach(v => srSel.option(String(v)));
  srSel.selected('44100');
  row4.child(srSel);

  // buttons
  let row5 = createDiv().class('row');
  btnPreview  = createButton('プレビュー再生').mousePressed(onPreview);
  btnStop     = createButton('停止').mousePressed(onStop);
  btnDownload = createButton('WAVを生成してDL').mousePressed(onDownload);
  row5.child(btnPreview);
  row5.child(btnStop);
  row5.child(btnDownload);

  statusP = createP('未生成').class('row');
  createP('出力は <code>volume_check_tone.wav</code>（WAV）です。mp3が必要なら後で変換してください。');
}

function ensureAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
}

function onStop() {
  if (currentSrc) {
    try { currentSrc.stop(); } catch(e) {}
    currentSrc.disconnect();
    currentSrc = null;
  }
  statusP.html('停止');
}

function onPreview() {
  ensureAudioCtx();
  onStop();

  const duration = durSlider.value();
  const amp = ampSlider.value();
  const fade = fadeSlider.value();
  const sr = Number(srSel.value());

  lastBuffer = makePinkNoiseBuffer(duration, sr, amp, fade);
  const buffer = audioCtx.createBuffer(1, lastBuffer.length, sr);
  buffer.copyToChannel(lastBuffer, 0);

  const src = audioCtx.createBufferSource();
  src.buffer = buffer;
  src.connect(audioCtx.destination);
  src.start();
  currentSrc = src;

  statusP.html(`プレビュー再生中（${duration}s, SR=${sr}）`);
  src.onended = () => {
    if (currentSrc === src) currentSrc = null;
    statusP.html('再生終了');
  };
}

function onDownload() {
  const duration = durSlider.value();
  const amp = ampSlider.value();
  const fade = fadeSlider.value();
  const sr = Number(srSel.value());

  const samples = makePinkNoiseBuffer(duration, sr, amp, fade);
  const wavBlob = encodeWav16(samples, sr);

  const a = document.createElement('a');
  a.href = URL.createObjectURL(wavBlob);
  a.download = 'volume_check_tone.wav';
  document.body.appendChild(a);
  a.click();
  a.remove();

  statusP.html(`DL作成（${duration}s, SR=${sr}, 約 ${(wavBlob.size/1024/1024).toFixed(1)} MB）`);
}

// --- pink noise generator (Paul Kellet style) ---
function makePinkNoiseBuffer(durationSec, sampleRate, gain, fadeSec) {
  const n = Math.floor(durationSec * sampleRate);
  const out = new Float32Array(n);

  let b0=0, b1=0, b2=0, b3=0, b4=0, b5=0, b6=0;

  for (let i=0; i<n; i++) {
    const white = Math.random()*2 - 1;

    b0 = 0.99886 * b0 + white * 0.0555179;
    b1 = 0.99332 * b1 + white * 0.0750759;
    b2 = 0.96900 * b2 + white * 0.1538520;
    b3 = 0.86650 * b3 + white * 0.3104856;
    b4 = 0.55000 * b4 + white * 0.5329522;
    b5 = -0.7616 * b5 - white * 0.0168980;
    const pink = (b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362) * 0.11;
    b6 = white * 0.115926;

    out[i] = pink * gain;
  }

  // fade in/out (クリック防止)
  const fadeN = Math.floor(fadeSec * sampleRate);
  if (fadeN > 0) {
    for (let i=0; i<Math.min(fadeN, n); i++) {
      out[i] *= (i / fadeN);
    }
    for (let i=0; i<Math.min(fadeN, n); i++) {
      const idx = n - 1 - i;
      out[idx] *= (i / fadeN);
    }
  }

  return out;
}

// --- WAV encoder (16-bit PCM, mono) ---
function encodeWav16(float32, sampleRate) {
  const numChannels = 1;
  const bytesPerSample = 2;
  const blockAlign = numChannels * bytesPerSample;
  const byteRate = sampleRate * blockAlign;
  const dataSize = float32.length * bytesPerSample;
  const buffer = new ArrayBuffer(44 + dataSize);
  const view = new DataView(buffer);

  let p = 0;
  function writeStr(s){ for(let i=0;i<s.length;i++) view.setUint8(p++, s.charCodeAt(i)); }
  function writeU32(v){ view.setUint32(p, v, true); p += 4; }
  function writeU16(v){ view.setUint16(p, v, true); p += 2; }

  writeStr('RIFF'); writeU32(36 + dataSize); writeStr('WAVE');
  writeStr('fmt '); writeU32(16);
  writeU16(1); // PCM
  writeU16(numChannels);
  writeU32(sampleRate);
  writeU32(byteRate);
  writeU16(blockAlign);
  writeU16(16); // bits
  writeStr('data'); writeU32(dataSize);

  // PCM samples
  for (let i=0; i<float32.length; i++) {
    let x = float32[i];
    x = Math.max(-1, Math.min(1, x));
    view.setInt16(p, x < 0 ? x * 0x8000 : x * 0x7FFF, true);
    p += 2;
  }

  return new Blob([buffer], { type: 'audio/wav' });
}
</script>
</body>
</html>
