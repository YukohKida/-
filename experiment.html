<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>音声/非音声 2AFC（恒常法, F/Jキー）</title>
  <!-- jsPsych v7 (CDN固定) -->
  <script src="https://cdn.jsdelivr.net/npm/jspsych@7.3.4/dist/jspsych.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jspsych@7.3.4/css/jspsych.css" />
  <!-- Plugins -->
  <script src="https://cdn.jsdelivr.net/npm/@jspsych/plugin-preload@1.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@jspsych/plugin-html-keyboard-response@1.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@jspsych/plugin-audio-keyboard-response@1.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@jspsych/plugin-survey-text@1.2.0"></script>
  <!-- DataPipe: jspsych-contrib/plugin-pipe -->
  <script src="https://cdn.jsdelivr.net/npm/@jspsych-contrib/plugin-pipe@0.5.0"></script>

  <style>
    body { background:#0b0c10; }
    .jspsych-content { max-width: 760px; color:#e6e6e6; }
    .muted { opacity:.8; font-size:.95rem; }
    kbd { padding:.1rem .35rem; border:1px solid #aaa; border-bottom-width:2px; border-radius:.35rem; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
<script>
// ========== 実験メタ情報 ==========
const EXP_ID  = "speech_vs_nonspeech_2AFC_MOCS_v1";
const VERSION = "2025-11-07"; // Asia/Tokyo

// ========== 参加者・セッション ==========
function getParam(name){ return new URL(location.href).searchParams.get(name); }
const PARTICIPANT_ID = getParam('pid') || `P${Math.random().toString(36).slice(2,10)}`;
const SESSION_ID     = `${Date.now()}`;

// ========== 刺激仕様 ==========
// 水準: 2–12 Hz を 2 Hz 刻み（6水準）× 各5ファイル = 30刺激
const LEVELS = [2,4,6,8,10,12];
// 命名規則: <category>_<hz>_<index>.mp3 例: speech_2_01.mp3, nonspeech_2_01.mp3
// 今回は「音声 vs 非音声」を判断させるが、評価は“音声と判断された割合”。正誤ラベルは付与しない。
// 実ファイルは /stimuli/ 配下に置くこと。
const FILES_PER_LEVEL = 5;

function buildStimList(){
  const arr = [];
  for(const hz of LEVELS){
    for(let i=1;i<=FILES_PER_LEVEL;i++){
      // ここではカテゴリを固定せず、ファイル名だけを持つ（判断は主観）。
      arr.push({
        condition_hz: hz,
        stim_path: `stimuli/${hz}_${String(i).padStart(2,'0')}.mp3`
      });
    }
  }
  return arr;
}

const TIMELINE_VARS = buildStimList(); // 30行想定

// 事前読み込み（ブラウザによってはユーザ操作後にデコード）
const PRELOAD_AUDIO = TIMELINE_VARS.map(v => v.stim_path).concat(['stimuli/volume_check_tone.mp3']);

// ========== jsPsych 初期化 ==========
const jsPsych = initJsPsych({
  on_finish: () => { /* ローカル保存はしない */ }
});

// すべてのtrialに共通プロパティを付与
jsPsych.data.addProperties({
  exp_id: EXP_ID,
  version: VERSION,
  participant_id: PARTICIPANT_ID,
  session_id: SESSION_ID,
  user_agent: navigator.userAgent
});

// ========== 試行パラメータ ==========
// F=音声(Speech), J=音声ではない(Non‑speech)
const KEY_SPEECH    = 'f';
const KEY_NONSPEECH = 'j';

function iti_ms(){ return 800 + Math.floor(Math.random()*401); } // 800–1200ms

// ========== タイムライン ==========
const timeline = [];

// 0) プリロード
timeline.push({
  type: jsPsychPreload,
  audio: PRELOAD_AUDIO,
  max_load_time: 120000,
  show_detailed_errors: true,
  message: '<p>音声を読み込んでいます…</p>'
});

// 1) 実験案内（キー操作）
timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <h2>音声/非音声 2AFC（F/Jキー）</h2>
    <p>各試行で音が1回再生されます。再生後、<kbd>F</kbd> = <strong>音声</strong>、<kbd>J</kbd> = <strong>音声ではない</strong> を押してください。</p>
    <p class="muted">反応時間制限なし。試行間間隔は 0.8–1.2 秒のランダム。</p>
    <p class="muted">ヘッドホン使用を推奨します。</p>
    <p>準備ができたら任意のキーを押して開始。</p>
  `,
  choices: "ALL_KEYS"
});

// 2) 音量調整（基準音）
timeline.push({
  type: jsPsychAudioKeyboardResponse,
  stimulus: 'stimuli/volume_check_tone.mp3',
  choices: [' '], // スペースで次へ
  prompt: '<p>基準音です。ヘッドホンの音量を調整し、<kbd>Space</kbd> で次へ。</p>',
  response_allowed_while_playing: false
});

// 3) 本試行（MOCS, 完全シャッフル）
// ITI用の空白トライアル
const iti = { type: jsPsychHtmlKeyboardResponse, stimulus: '', choices: 'NO_KEYS', trial_duration: () => iti_ms() };

// 2AFC本体
const trial_2afc = {
  type: jsPsychAudioKeyboardResponse,
  stimulus: jsPsych.timelineVariable('stim_path'),
  choices: [KEY_SPEECH, KEY_NONSPEECH],
  response_allowed_while_playing: false,
  prompt: () => (
    `<p class="muted">再生後に <kbd>${KEY_SPEECH.toUpperCase()}</kbd>=音声 / <kbd>${KEY_NONSPEECH.toUpperCase()}</kbd>=音声ではない</p>`
  ),
  data: {
    task: '2AFC',
    condition_hz: jsPsych.timelineVariable('condition_hz'),
    stim_path: jsPsych.timelineVariable('stim_path')
  },
  on_finish: (data) => {
    const key = jsPsych.pluginAPI.compareKeys(data.response, KEY_SPEECH) ? KEY_SPEECH : KEY_NONSPEECH;
    data.response_key   = key;
    data.response_label = (key === KEY_SPEECH) ? 'speech' : 'nonspeech';
    // 正誤は定義しない（割合解析用）
  }
};

// シャッフル
const shuffled = jsPsych.randomization.shuffle(TIMELINE_VARS);

// 本試行: [trial, ITI] × 30
shuffled.forEach(v => {
  timeline.push({ timeline: [trial_2afc, iti], timeline_variables: [v] });
});

// 4) 属性
timeline.push({
  type: jsPsychSurveyText,
  questions: [
    { prompt: '年齢（任意）', name: 'age', required: false },
    { prompt: '性別（任意）', name: 'gender', required: false }
  ],
  data: { task: 'demographics' }
});

// 5) 終了画面
timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: '<h2>終了</h2><p>ご協力ありがとうございました。</p><p class="muted">データ送信を行います。画面が切り替わるまでそのままお待ちください。</p>',
  choices: 'NO_KEYS',
  trial_duration: 800
});

// ========== DataPipe 送信（終了時のみ） ==========
// DataPipe で発行された experiment ID を設定し、ダッシュボード推奨のファイル名関数を使う。
const DATAPIPE_EXPERIMENT_ID = 'REPLACE_WITH_YOUR_EXPERIMENT_ID'; // pipe.jspsych.org で作成

const save_to_datapipe = {
  type: jsPsychPipe,
  action: 'save',
  experiment_id: DATAPIPE_EXPERIMENT_ID,
  filename: () => `${EXP_ID}_${PARTICIPANT_ID}_${SESSION_ID}.csv`,
  data_string: () => jsPsych.data.get().csv()
};

timeline.push(save_to_datapipe);

// ========== 実行 ==========
jsPsych.run(timeline);
</script>
</body>
</html>
