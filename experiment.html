<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>音声/非音声 2AFC（恒常法, F/Jキー）</title>
  <!-- jsPsych core -->
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" />
  <!-- plugins（v7系のページが提示している版に合わせる） -->
  <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-audio-keyboard-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3"></script>
  <!-- ボタン系（ここは v7 docs で 1.2.0 が案内されている） -->
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.2.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-audio-button-response@1.2.0"></script>
  <!-- DataPipe: jspsych-contrib/plugin-pipe -->
  <script src="https://cdn.jsdelivr.net/npm/@jspsych-contrib/plugin-pipe@0.5.0/dist/index.browser.min.js"></script>

  <style>
    body { background:#0b0c10; }
    .jspsych-content { max-width: 760px; color:#e6e6e6; }
    .muted { opacity:.8; font-size:.95rem; }
    kbd { padding:.1rem .35rem; border:1px solid #aaa; border-bottom-width:2px; border-radius:.35rem; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .jspsych-btn{
      font-size: 1.2rem;
      padding: 1rem 1.25rem;
      margin: .5rem .25rem;
      min-height: 48px; /* タップしやすく */
    }
  </style>
</head>
<body>
<script>
// ========== 実験メタ情報 ==========
const EXP_ID  = "speech_vs_nonspeech_2AFC_MOCS_v1";
const VERSION = "2025-11-07"; // Asia/Tokyo

// ========== 参加者・セッション ==========
function getParam(name){ return new URL(location.href).searchParams.get(name); }
const PARTICIPANT_ID = getParam('pid') || `P${Math.random().toString(36).slice(2,10)}`;
const SESSION_ID     = `${Date.now()}`;

// ========== 刺激仕様 ==========
// 水準
const LEVELS = [2,4,6,8,10,12];

// 各Hzにある s 番号（あなたの例）
const S_IDS = [31,32,33,34,35];

// 末尾の _1 が固定なら
const TAKE = 1;

function buildStimList(){
  const arr = [];
  for(const hz of LEVELS){
    for(const s of S_IDS){
      arr.push({
        condition_hz: hz,
        s_id: s,
        stim_path: `stimuli/sample_${hz}Hz_s${s}_${TAKE}.wav`
      });
    }
  }
  return arr; // 6*5=30
}

const TIMELINE_VARS = buildStimList();

// 事前読み込み（ブラウザによってはユーザ操作後にデコード）
const PRELOAD_AUDIO = TIMELINE_VARS.map(v => v.stim_path).concat(['stimuli/volume_check_tone.wav']);

// ========== jsPsych 初期化 ==========
const jsPsych = initJsPsych({
  on_finish: () => { /* ローカル保存はしない */ }
});

// すべてのtrialに共通プロパティを付与
jsPsych.data.addProperties({
  exp_id: EXP_ID,
  version: VERSION,
  participant_id: PARTICIPANT_ID,
  session_id: SESSION_ID,
  user_agent: navigator.userAgent
});

// ========== 試行パラメータ ==========
// F=音声(Speech), J=音声ではない(Non‑speech)
const KEY_SPEECH    = 'f';
const KEY_NONSPEECH = 'j';

function iti_ms(){ return 800 + Math.floor(Math.random()*401); } // 800–1200ms

// ========== タイムライン ==========
const timeline = [];

// 0) プリロード
timeline.push({
  type: jsPsychPreload,
  audio: PRELOAD_AUDIO,
  max_load_time: 120000,
  show_detailed_errors: true,
  message: '<p>音声を読み込んでいます…</p>'
});

// 1) 実験案内（キー操作）
timeline.push({
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <h2>音声/非音声 2AFC</h2>
    <p>各試行で音が1回再生されます。再生後、<strong>音声</strong> または <strong>音声ではない</strong> を選んでください。</p>
    <p class="muted">PCでは <kbd>F</kbd>=音声 / <kbd>J</kbd>=音声ではない でも回答できます。</p>
  `,
  choices: ['開始'],
  on_load: () => {
    // PCキーボードでも開始できるように（任意）
    const l = jsPsych.pluginAPI.getKeyboardResponse({
      callback_function: () => document.querySelector('.jspsych-btn')?.click(),
      valid_responses: "ALL_KEYS",
      rt_method: "performance",
      persist: false
    });
  }
});

// 2) 音量調整（基準音）
timeline.push({
  type: jsPsychAudioButtonResponse,
  stimulus: 'stimuli/volume_check_tone.wav',
  choices: ['次へ'],
  prompt: '<p>基準音です。音量を調整して <strong>次へ</strong> を押してください。</p>',
  response_allowed_while_playing: true
});

// 3) 本試行（MOCS, 完全シャッフル）
// ITI用の空白トライアル
const iti = { type: jsPsychHtmlKeyboardResponse, stimulus: '', choices: 'NO_KEYS', trial_duration: () => iti_ms() };

// 2AFC本体
const trial_2afc = {
  type: jsPsychAudioButtonResponse,
  stimulus: jsPsych.timelineVariable('stim_path'),
  choices: ['音声', '音声ではない'],
  response_allowed_while_playing: false,
  prompt: () => (
    `<p class="muted">（PC：<kbd>F</kbd>=音声 / <kbd>J</kbd>=音声ではない）</p>`
  ),
  data: {
    task: '2AFC',
    condition_hz: jsPsych.timelineVariable('condition_hz'),
    stim_path: jsPsych.timelineVariable('stim_path')
  },
  on_start: (trial) => { trial._resp_source = 'touch'; },
  on_load: () => {
    // ボタン試行にキーボードも足す（任意）
    const btns = () => document.querySelectorAll('.jspsych-btn');
    jsPsych.pluginAPI.getKeyboardResponse({
      callback_function: (info) => {
        const key = info.key.toLowerCase();
        if(key === KEY_SPEECH){
          jsPsych.getCurrentTrial()._resp_source = 'keyboard';
          btns()[0]?.click(); // 「音声」
        } else if(key === KEY_NONSPEECH){
          jsPsych.getCurrentTrial()._resp_source = 'keyboard';
          btns()[1]?.click(); // 「音声ではない」
        }
      },
      valid_responses: [KEY_SPEECH, KEY_NONSPEECH],
      rt_method: "performance",
      persist: true,          // タップで終了しても生き続けないように、次行で消す
      allow_held_key: false
    });

    // trial終了時に自動でDOMが消えるので、persist:trueでも積み上がりにくいが、
    // 気になるなら persist:false + 1回押しのみ、でもOK。
  },
  on_finish: (data) => {
    // audio-button-responseの response は「choices の index」(0/1)
    const idx = data.response;
    data.response_label = (idx === 0) ? 'speech' : 'nonspeech';
    data.response_key   = (idx === 0) ? KEY_SPEECH : KEY_NONSPEECH; // 互換用に残す
    data.response_source = jsPsych.getCurrentTrial()._resp_source;   // touch/keyboard
  }
};

// シャッフル（手続きブロック）
const procedure = {
  timeline: [trial_2afc, iti],
  timeline_variables: TIMELINE_VARS,
  randomize_order: true
};

// ★ここで push（属性の前）
timeline.push(procedure);

// 4) 属性
timeline.push({
  type: jsPsychSurveyText,
  questions: [
    { prompt: '年齢（任意）', name: 'age', required: false },
    { prompt: '性別（任意）', name: 'gender', required: false }
  ],
  data: { task: 'demographics' }
});

// 5) 終了画面
timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: '<h2>終了</h2><p>ご協力ありがとうございました。</p><p class="muted">データ送信を行います。画面が切り替わるまでそのままお待ちください。</p>',
  choices: 'NO_KEYS',
  trial_duration: 800
});

// ========== DataPipe 送信（終了時のみ） ==========
// DataPipe で発行された experiment ID を設定し、ダッシュボード推奨のファイル名関数を使う。
const DATAPIPE_EXPERIMENT_ID = 'REPLACE_WITH_YOUR_EXPERIMENT_ID'; // pipe.jspsych.org で作成

const save_data = {
  type: jsPsychPipe,
  action: "save",
  experiment_id: "2xDqhflOiUKP",
  filename: experiment_data,
  data_string: ()=>jsPsych.data.get().csv()
};

timeline.push(save_to_datapipe);

// ========== 実行 ==========
jsPsych.run(timeline);
</script>
</body>
</html>
